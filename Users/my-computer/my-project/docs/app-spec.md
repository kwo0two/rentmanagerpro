# 임대료 관리 시스템 앱 명세서

이 문서는 애플리케이션의 전체 구조, 메뉴, 화면별 기능, 데이터 처리 규칙을 정의하는 절대적인 기준입니다. 모든 코드 생성 및 수정은 이 명세서를 기반으로 합니다.

## 1. 데이터베이스 구조 (Firestore Collections)

이 앱은 다음 최상위 컬렉션들을 사용합니다.

-   **`buildings`**: 사용자가 소유한 건물 정보를 저장합니다.
    -   `id`, `ownerId`, `name`, `address`
    -   `units`: `{ id, name, area }` 객체 배열. 건물의 각 호실 정보.
-   **`leaseAgreements`**: 모든 임대차 계약 정보를 저장합니다. 이 컬렉션은 앱의 핵심입니다. 하나의 문서는 하나의 계약을 의미하며, 이를 통해 특정 호실의 과거 계약 이력과 현재 계약을 모두 관리할 수 있습니다.
    -   `id`, `ownerId`, `buildingId`, `buildingName`, `tenantName`, `tenantContact`, `tenantAddress`, `unitIds`, `leaseStartDate`, `leaseEndDate`, `leaseDepositAmount`, `rentAmount`, `vatTreatment`, `paymentMethod`, `rentCalculationMethod`, `rentFreePeriod`, `rentFreeUnit`
    -   `renewals`: `[{ renewalDate, newRentAmount, newLeaseEndDate }]` 객체 배열. 재계약 이력을 저장합니다.
-   **`payments`**: 모든 납부 기록을 저장합니다.
    -   `id`, `ownerId`, 'leaseAgreementId', `paymentDate`, `paymentAmount`
-   **`rentAdjustments`**: 특정 월의 임대료 조정을 저장합니다.
    -   `id`, `ownerId`, `leaseAgreementId`, `adjustmentDate` (조정 대상 월의 1일), `adjustedRentAmount`, `notes`
-   **`users`**: 사용자 프로필 및 역할 정보를 저장합니다.
    -   `id`, `email`, `displayName`, `isApproved` (관리자 승인 여부 boolean)
-   **`logs`**: 주요 활동에 대한 감사 로그를 저장합니다.
    -   `id`, `userId`, `userEmail`, `action`, `timestamp`, `details`

## 2. 메뉴 구조 (Navigation)

사이드바 메뉴는 다음 구조를 따릅니다.

-   **대시보드**: 앱의 메인 랜딩 페이지.
-   **건물 관리**: 등록된 건물 목록을 관리.
-   **임차인 관리**: 건물별 임차인 계약 목록을 관리.
-   **납부 기록 관리**: 건물별, 임차인별 납부 기록을 확인.
-   **설정**: 데이터 백업/복원 및 초기화 기능.
-   **감사 로그**: 시스템의 주요 변경 이력을 확인.

## 3. 사용자 인증 및 권한 모델

-   **회원가입:** 누구나 이메일과 비밀번호로 회원가입을 할 수 있습니다.
-   **승인 시스템:**
    -   회원가입 직후 사용자는 `users` 컬렉션에 `isApproved: false` 상태로 저장됩니다.
    -   미승인 사용자는 로그인 시 "승인 대기 중" 화면으로 안내되며, 로그아웃 외의 다른 기능을 사용할 수 없습니다.
-   **권한:**
    -   관리자가 Firestore 콘솔 등에서 사용자의 `isApproved` 값을 `true`로 변경하면 해당 사용자는 앱의 모든 기능에 접근할 수 있습니다.
    -   **승인된 사용자는 앱의 모든 데이터(모든 건물, 모든 임차인, 모든 납부 기록 등)에 대한 읽기/쓰기/삭제 권한을 가집니다.** (데이터는 더 이상 개별 사용자에게 귀속되지 않습니다.)

## 4. 화면별 세부 기능 명세

### 4.1. 대시보드 (`/dashboard`)

-   **목표**: 전체 임대 현황을 한눈에 파악하고 모든 임차인 목록을 제공합니다.
-   **데이터 카드 (Stat Cards)**:
    -   **총 임차인**: 현재 활성화된(계약 기간이 종료되지 않은) 모든 `leaseAgreements` 문서의 총 개수.
    -   **입주율**: (임대된 총 호실 수 / 등록된 모든 건물의 총 호실 수) * 100.
    -   **월 총 임대료**: 모든 활성 `leaseAgreements`의 `rentAmount` 필드(재계약 금액 포함)의 총합.
    -   **연체된 임대료**: 모든 활성 임차인의 `balance` 필드(아래 계산식 참조)가 0보다 큰 경우, 그 `balance`의 총합.
-   **전체 임차인 테이블 (`AllTenantsTable`)**:
    -   **데이터 소스**: **모든** `leaseAgreements` 컬렉션 및 관련 `payments`. 과거 계약과 현재 계약을 모두 포함하여 보여줍니다.
    -   **표시 항목**: 호수, 이름, 계약 종료일, 상태, 잔액. (상태 및 잔액은 '핵심 데이터 처리 규칙' 참조)
    -   **기능**:
        -   이름으로 목록을 검색할 수 있습니다.
        -   각 행을 클릭하면 해당 임차인의 상세 원장 페이지(`/tenants/{leaseId}`)로 이동합니다.

### 4.2. 건물 관리 (`/buildings`)

-   **목표**: 모든 건물을 등록하고 관리합니다.
-   **데이터 소스**: **모든** `buildings` 컬렉션.
-   **기능**:
    -   건물 목록을 카드 형태로 보여줍니다. 각 카드에는 건물 이름, 주소, 총 임차인 수(관련 `leaseAgreements` 개수), 총 호실 수가 표시됩니다.
    -   '건물 추가' 버튼을 통해 새 건물을 등록할 수 있습니다 (`/buildings/new`).
    -   각 건물을 클릭하면 정보를 수정할 수 있습니다 (`/buildings/{buildingId}/edit`).
    -   건물별 호실과 면적(제곱미터 단위)을 등록 및 삭제할 수 있습니다.
    -   건물 정보를 삭제할 수 있습니다.

### 4.3. 임차인 관리 (`/tenants`)

-   **목표**: 특정 건물에 속한 임차인 계약을 관리합니다.
-   **데이터 소스**:
    1.  **모든** `buildings` 컬렉션 (건물 선택 드롭다운용).
    2.  선택된 건물 ID에 해당하는 `leaseAgreements` 컬렉션.
-   **기능**:
    -   건물 선택 드롭다운 메뉴를 제공합니다.
    -   건물을 선택하면 해당 건물에 속한 임차인 목록(과거 계약 포함)을 테이블 형태로 보여줍니다.
    -   '임차인 추가' 버튼을 통해 새 임차인 계약을 등록할 수 있습니다 (`/tenants/new`).

### 4.4. 임차인 상세 (원장) (`/tenants/{leaseId}`)

-   **목표**: 특정 임차인 계약의 상세 정보와 모든 거래 내역(원장)을 보여줍니다.
-   **데이터 소스**:
    1.  `leaseId`에 해당하는 `leaseAgreements` 문서.
    2.  해당 `leaseId`를 참조하는 `payments` 컬렉션의 모든 문서.
    3.  해당 `leaseId`를 참조하는 `rentAdjustments` 컬렉션의 모든 문서.
-   **기능**:
    -   계약 정보(임차인, 건물, 기간, 임대료 등)를 상세히 표시합니다.
    -   임대료 청구 내역과 납부 내역을 날짜순으로 정렬된 테이블(원장)로 보여줍니다. (계산 방식은 '핵심 데이터 처리 규칙' 참조)
    -   **월별 임대료 조정**: 원장의 각 청구 항목 옆에 '수정' 버튼을 두어, 특정 월의 임대료를 수정하고 비고를 남길 수 있습니다. 이는 `rentAdjustments` 컬렉션에 저장됩니다.
    -   모든 거래 내역의 최종 잔액을 계산하여 표시합니다.
    -   원장 내용을 엑셀 파일로 내보낼 수 있습니다.
    -   원장 내용을 인쇄할 수 있습니다.
    -   **계약 수정**: '계약 수정' 버튼을 통해 계약 정보를 수정할 수 있습니다 (`/tenants/{id}/edit`). 재계약 정보도 여기서 관리합니다.
    -   **계약 삭제**: '계약 삭제' 버튼을 통해 임대차 계약을 영구적으로 삭제할 수 있습니다. 삭제 시 관련된 모든 납부 기록과 임대료 조정 기록도 함께 삭제됩니다.

### 4.5. 납부 기록 관리 (`/payments`)

-   **목표**: 건물별, 임차인별 납부 기록을 효율적으로 확인하고 관리합니다.
-   **데이터 소스**: **모든** `buildings`, `leaseAgreements`, `payments` 컬렉션.
-   **기능**:
    -   **건물 선택**: 페이지 상단에 건물을 선택할 수 있는 드롭다운 메뉴를 제공합니다.
    -   **임차인별 그룹화**: 건물을 선택하면, 해당 건물의 임차인별로 납부 기록이 그룹화되어 아코디언 메뉴 형태로 표시됩니다.
        -   각 아코디언 헤더에는 임차인 이름, 호실, 총 납부액, 총 납부 건수가 표시됩니다.
    -   **상세 내역 확인**: 아코디언을 펼치면 해당 임차인의 모든 납부 기록을 날짜와 금액별로 확인할 수 있습니다.
    -   **납부 기록 수정 및 삭제**: 각 납부 기록을 클릭하면 수정 또는 삭제할 수 있는 다이얼로그가 나타납니다.
    -   **납부 기록 추가**: '납부 기록 추가' 버튼을 통해 새 납부 내역을 등록하는 페이지(`/payments/new`)로 이동합니다.

### 4.6. 신규 납부 기록 (`/payments/new`)

-   **목표**: 단일 또는 여러 개의 납부 기록을 한번에 추가합니다.
-   **기능**:
    -   납부 기록을 추가할 임차인을 선택합니다.
    -   **단일 추가**: 특정 날짜에 대한 단일 납부 기록을 추가합니다.
    -   **일괄 추가**: 여러 개의 납부 기록을 한번에 생성합니다.
        -   **기간 설정**: 시작 월과 종료 월을 선택하여 납부 기록을 생성할 기간을 지정합니다.
        -   **납부일 지정 방식**: '매월 같은 날짜' 또는 '날짜 직접 선택' 옵션을 제공하여 유연하게 납부일을 설정할 수 있습니다.

### 4.7. 설정 (`/settings`)

-   **목표**: 애플리케이션 데이터를 관리합니다.
-   **기능**:
    -   **데이터 백업**: **모든** 데이터(건물, 임차인, 납부 기록)를 JSON 파일로 다운로드합니다.
    -   **데이터 복원**: JSON 백업 파일을 업로드하여 **모든** 데이터를 덮어씁니다. 복원 전 기존 데이터는 모두 삭제됩니다.
    -   **데이터 초기화**: **모든** 데이터를 영구적으로 삭제합니다.

### 4.8. 감사 로그 (`/audit-logs`)

-   **목표**: 시스템에서 발생한 주요 이벤트를 추적합니다.
-   **데이터 소스**: **모든** `logs` 컬렉션.
-   **기능**:
    -   모든 로그 기록을 최신순으로 테이블에 표시합니다.
    -   표시 항목: 시간, 사용자 이메일, 작업 종류, 상세 정보.

## 5. 핵심 데이터 처리 규칙

### 5.1. 잔액 (Balance) 계산

-   **정의**: 특정 시점(오늘)까지 발생한 총 임대료에서 총 납부액을 뺀 금액.
-   **계산 로직**:
    -   `총 임대료`: 계약 시작일부터 오늘까지 발생해야 할 모든 월 임대료의 합계. (아래 '월 임대료 발생 규칙' 참조)
    -   `총 납부액`: 해당 계약과 연결된 모든 `payments` 문서의 `paymentAmount` 총합.
    -   `잔액 = 총 임대료 - 총 납부액`

### 5.2. 월 임대료 발생 규칙 (원장 생성 로직)

임대료는 계약서에 명시된 `rentCalculationMethod`에 따라 두 가지 방식으로 계산되어 원장에 기록됩니다. 원장은 오늘 날짜까지 발생한 내역만 생성합니다.

#### 5.2.1. 계약일 기준 (`contract_date`)

-   **설명**: 매월 계약 시작일에 해당하는 날짜에 월 임대료가 발생합니다.
-   **규칙**:
    1.  **기본 발생**: 계약 시작일부터 매월 해당 일에 월 임대료(`rentAmount`)가 발생합니다. (예: 1월 15일 계약 -> 2월 15일, 3월 15일...)
    2.  **렌트프리 (개월)**: 계약 시작 후 `rentFreePeriod` 개월 수만큼 임대료가 0으로 발생합니다.
    3.  **렌트프리 (일)**: 첫 달에만 적용되며, `rentFreePeriod` 일 수만큼을 제외하고 일할 계산됩니다. `(월 임대료 / 해당 월의 총 일수) * (해당 월의 총 일수 - 렌트프리 일수)`
    4.  **마지막 달**: 계약이 월 중간에 끝나는 경우, 마지막달은 일할 계산됩니다. `(월 임대료 / 해당 월의 총 일수) * (실제 계약 일수)`
    5.  **재계약**: 재계약 날짜(`renewalDate`) 이후부터 발생하는 임대료는 `newRentAmount`를 기준으로 계산됩니다.
    6.  **월별 조정**: `rentAdjustments` 컬렉션에 해당 월의 조정 데이터가 있으면, 그 달의 임대료는 `adjustedRentAmount`로 대체되고, `notes` 필드 내용이 원장 비고에 표시됩니다.

#### 5.2.2. 말일 기준 (`end_of_month`)

-   **설명**: 매월 말일에 해당 월의 임대료가 발생하며, 첫 달과 마지막 달은 일할 계산됩니다.
-   **규칙**:
    1.  **기본 발생**: 매월 말일에 월 임대료(`rentAmount`)가 발생합니다.
    2.  **첫 달**: 계약 시작일부터 해당 월의 말일까지의 기간에 대해 일할 계산됩니다. `(월 임대료 / 해당 월의 총 일수) * (실제 계약 일수)`
    3.  **마지막 달**: 해당 월의 시작일부터 계약 종료일까지의 기간에 대해 일할 계산됩니다. `(월 임대료 / 해당 월의 총 일수) * (실제 계약 일수)`
    4.  **렌트프리**: 계약 시작 후 `rentFreePeriod` 기간(일 또는 개월) 동안 발생하는 임대료는 0으로 처리됩니다. 렌트프리 기간이 월 중간에 걸쳐 있는 경우, 해당 월의 임대료는 렌트프리 기간을 제외하고 일할 계산됩니다.
    5.  **재계약**: 재계약 날짜(`renewalDate`) 이후부터 발생하는 임대료는 `newRentAmount`를 기준으로 계산됩니다.
    6.  **월별 조정**: `rentAdjustments` 컬렉션에 해당 월의 조정 데이터가 있으면, 그 달의 임대료는 `adjustedRentAmount`로 대체되고, `notes` 필드 내용이 원장 비고에 표시됩니다.

### 5.3. 임차인 상태 (Tenant Status) 계산

-   **`vacant` (공실)**: 계약 종료일(`leaseEndDate` 또는 재계약 후 `newLeaseEndDate`)이 오늘 날짜보다 과거일 때. 이 상태의 계약은 "과거 계약" 또는 "전 계약자"를 의미합니다. 이 상태는 잔액과 무관하게 최우선으로 판단됩니다.
-   **`overdue` (연체)**: `balance > 0` 이고 계약 기간이 아직 종료되지 않았을 때.
-   **`paid` (납부 완료)**: `balance <= 0` 이고 계약 기간이 아직 종료되지 않았을 때.

### 5.4. 부가세 (VAT) 처리 규칙 (`vatTreatment`)

원장 테이블에 표시되는 금액은 부가세 처리 방식에 따라 다음과 같이 계산됩니다.

-   **`none` (미발행)**: 공급가액 = 임대료, 부가세 = 0, 합계 = 임대료
-   **`excluded` (별도)**: 공급가액 = 임대료, 부가세 = 임대료의 10%, 합계 = 공급가액 + 부가세
-   **`included` (포함)**: 공급가액 = 임대료 / 1.1, 부가세 = 임대료 - 공급가액, 합계 = 임대료

---
*이 문서는 2024-05-24에 마지막으로 업데이트되었습니다.*
