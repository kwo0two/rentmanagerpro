# MCP (My Coding Principles) - AI 코딩 파트너 원칙

이 문서는 AI 코딩 파트너가 이 프로젝트의 코드를 생성하고 수정할 때 따르는 핵심적인 기술 원칙과 표준 시공법(MCP)을 정의합니다. `app-spec.md`가 **무엇(WHAT)**을 만들지 정의하는 설계도라면, 이 문서는 **어떻게(HOW)** 만들지에 대한 시공 지침서입니다. 모든 코드는 이 원칙을 따라 작성되어야 하며, 이는 프로젝트의 안정성과 유지보수성을 보장하는 약속입니다.

## 1. 핵심 원칙: 예측 가능하고 안정적인 코드

우리의 최우선 목표는 **"개발 환경에서는 잘 되는데, 빌드/배포 시에 실패하는"** 문제를 원천적으로 차단하는 것입니다. 모든 코드는 예기치 않은 동작을 최소화하고, 누가 보아도 의도가 명확하게 작성되어야 합니다.

### **MCP 1: 방어적 데이터 변환 (Defensive Data Transformation)**

-   **원칙:** 외부 시스템(특히 Firestore)에서 들어온 데이터는 **절대 그대로 신뢰하지 않습니다.** 데이터가 우리 앱의 특정 함수나 컴포넌트에서 사용되기 전에, 반드시 **중앙 유틸리티 함수(예: `src/lib/utils.ts`)를 거쳐 명확하고 안전한 타입(Primitive Type)으로 변환**합니다.
-   **실천 방안:**
    -   Firestore의 `Timestamp` 객체는 컴포넌트로 전달하기 전에, 유틸리티 함수 내에서 `toDate()` 메소드를 호출하여 JavaScript의 `Date` 객체로 변환합니다.
    -   데이터 객체를 받을 때는 항상 `?.` (Optional Chaining)을 사용하여 `null` 또는 `undefined` 가능성에 대비합니다.
    -   `getLeaseDetails`, `formatDate`와 같은 유틸리티 함수는 이런 '방어적 변환'을 책임지는 유일한 관문 역할을 합니다.
-   **기대 효과:** `Timestamp`와 `Date` 혼용으로 인한 타입 오류, `null` 참조로 인한 런타임 오류를 사전에 완벽하게 차단합니다.

### **MCP 2: 단일 책임 원칙 (Single Responsibility Principle) 강화**

-   **원칙:** 하나의 함수, 하나의 컴포넌트는 **오직 하나의 명확한 책임**만 가집니다. 부수적인 기능(Side Effect)은 명시적으로 분리합니다.
-   **실천 방안:**
    -   **데이터 조작 분리:** `deleteDocument` 함수는 오직 '삭제'만 수행합니다. '감사 로그 기록'과 같은 추가 작업은 이 함수를 호출하는 상위 로직에서 별도로 처리하거나, 필요하다면 해당 기능을 담당하는 다른 서비스를 호출해야 합니다.
    -   **UI와 로직 분리:** 데이터 조회 및 가공(Logic)은 커스텀 훅(Custom Hook)이나 서버 컴포넌트 최상단에서 처리하고, 하위 UI 컴포넌트는 오직 전달받은 데이터를 화면에 그리는(Presentational) 책임만 집니다.
-   **기대 효과:** 기능 수정 시 영향 범위를 최소화합니다. (예: 로그 정책 변경이 데이터 삭제 로직에 영향을 주지 않음) 이는 이전에 우리가 겪었던, 하나의 수정이 수많은 파일에 걸쳐 연쇄적인 빌드 오류를 일으켰던 문제를 근본적으로 방지합니다.

## 2. Firebase 사용 지침

-   **보안 규칙 우선:** 모든 데이터 접근은 Firestore 보안 규칙을 통해 제어됩니다. 현재 정책은 **승인된 사용자(`isApproved: true`)**는 모든 데이터에 접근할 수 있도록 허용하는 것입니다.
-   **쿼리 단순화:** 새로운 권한 정책에 따라, 더 이상 쿼리에서 `ownerId`를 확인할 필요가 없습니다. 모든 데이터 조작은 로그인한 승인된 사용자에 의해 수행됩니다.
-   **상태 관리:** `useCollection`, `useDoc` 훅을 사용하여 Firestore 데이터와 컴포넌트를 동기화할 때, 쿼리나 참조 객체는 반드시 `useMemoFirebase`로 메모이제이션하여 불필요한 재실행을 방지합니다.

## 3. UI/UX 가이드라인

-   **일관성:** ShadCN/UI 컴포넌트를 최대한 활용하고, 중요한 작업(삭제 등)에는 항상 `AlertDialog`를 사용하여 사용자에게 재확인 절차를 제공합니다. 작업 결과는 `Toast`로 피드백합니다.

## 4. 코드 품질 및 컨벤션

-   **타입스크립트:** 모든 곳에 엄격한 타입 사용을 원칙으로 하며, 공유 타입은 `src/lib/types.ts`에 정의합니다.
-   **비동기 처리:** 모든 비동기 로직에는 `try...catch` 구문을 사용하여 오류를 처리하고, 로딩 및 오류 상태를 UI에 명확히 표시합니다.

---
*이 문서는 반복된 빌드 오류와 권한 문제를 해결하는 과정에서 얻은 교훈을 바탕으로, 프로젝트의 안정성과 명확성을 최우선으로 확보하기 위해 개정되었습니다.*
