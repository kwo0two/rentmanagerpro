/**
 * This ruleset enforces a strict user-ownership model for a property management application.
 *
 * Core Philosophy:
 * All data, including lease agreements and their associated payments, is considered private
 * and owned by the user (landlord) who created it. There is no public or shared data.
 * A user can only access data that exists directly under their own user ID in the path.
 *
 * Data Structure:
 * The data is organized hierarchically to reflect ownership clearly:
 * /users/{userId}/...
 * This structure ensures that all data for a specific user is isolated within their
 * own data tree, simplifying security and queries.
 *
 * Key Security Decisions:
 * - Strict Data Isolation: Users are strictly confined to their own data tree. They cannot
 *   read, write, or even know about the existence of data belonging to other users.
 * - No Public Listing: It is impossible for any user to list all lease agreements or
 *   all users in the system.
 * - Path and Data Integrity: Rules enforce that documents contain internal IDs (like a
 *   `userId`) that match the IDs in their document path. This prevents data from being

 *   created in the wrong location and ensures relational integrity.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to abstract and reuse common security logic.

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the fundamental check for data ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete
     * operations to prevent acting on non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates a new LeaseAgreement on creation.
     * Ensures the creator is the owner and that the document's internal IDs
     * match the IDs in its path for relational integrity.
     */
    function isCreatingLeaseAgreement(userId, leaseAgreementId) {
      return isOwner(userId)
          && request.resource.data.ownerId == userId
          && request.resource.data.id == leaseAgreementId;
    }

    /**
     * Validates a LeaseAgreement on update.
     * Ensures the user is the owner and that critical relational IDs are immutable.
     */
    function isUpdatingLeaseAgreement(userId) {
      return isExistingOwner(userId)
          && request.resource.data.ownerId == resource.data.ownerId
          && request.resource.data.id == resource.data.id;
    }

    /**
     * Validates a new Payment on creation.
     * Ensures the creator owns the parent lease and that the document's internal IDs
     * match the IDs in its path for relational integrity.
     */
    function isCreatingPayment(userId, leaseAgreementId, paymentId) {
      return isOwner(userId)
          && request.resource.data.ownerId == userId
          && request.resource.data.leaseAgreementId == leaseAgreementId
          && request.resource.data.id == paymentId;
    }

    /**
     * Validates a Payment on update.
     * Ensures the user is the owner and that critical relational IDs are immutable.
     */
    function isUpdatingPayment(userId) {
      return isExistingOwner(userId)
          && request.resource.data.ownerId == resource.data.ownerId
          && request.resource.data.leaseAgreementId == resource.data.leaseAgreementId
          && request.resource.data.id == resource.data.id;
    }

    /**
     * @description Rules for the users collection.
     * Users can read their own profile. Admins can read/write any profile (for approval).
     * New user profiles are created during sign-up.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      // Only authenticated users can create their own user document
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      // Users can update their own profile, but cannot change their approval status.
      allow update: if isOwner(userId) && request.resource.data.isApproved == resource.data.isApproved;
    }

    // Rules for top-level collections
    match /{collection}/{docId} {
        // Generic rule for collections where documents have an `ownerId`
        function isDocOwner() {
            return request.auth.uid == resource.data.ownerId;
        }

        function isCreatingDocWithOwner(ownerId) {
            return request.auth.uid == ownerId && request.resource.data.ownerId == ownerId;
        }
        
        allow read, delete: if isDocOwner();
        allow create: if isCreatingDocWithOwner(request.auth.uid);
        allow update: if isDocOwner() && request.resource.data.ownerId == resource.data.ownerId;
    }
  }
}
